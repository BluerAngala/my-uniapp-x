<template>
	<!-- #ifdef MP-WEIXIN -->
	<view class='tui-animation-main' :animation="animationData" :style="animationStyles" @transitionend="transitionend"
		@click="mainOnclick">
		<slot></slot>
	</view>
	<!-- #endif -->
	<!-- #ifndef MP-WEIXIN -->
	<view class='tui-animation-main' :style="animationStyles" @click="mainOnclick">
		<slot></slot>
	</view>
	<!-- #endif -->
</template>

<script setup>
	/**
	 * Animation 动画组件
	 * @description 支持预设动画和自定义动画，支持声明式和命令式两种使用方式
	 * @property {String} preset 预设动画名称：heartbeat/shake/bounce/breathe/pulse/fadeIn/fadeOut/flipX/flipY/vibrate/blink/popIn/popOut/slideInLeft/slideInRight/slideInUp/slideInDown/jelly/rubber/spring/drop/jump/headShake/nod/like/spinIn/roll/wink/wobble/pendulum/float/loading/spin/zoomIn/zoomOut
	 * @property {Boolean} loop 是否循环播放（仅对支持循环的预设有效）
	 * @property {Boolean} autoPlay 是否自动播放
	 * @property {Number} duration 动画时长（毫秒）
	 * @property {String} mainClass 组件根节点的样式
	 * @event {Function} click 点击时触发
	 * @event {Function} transitionend 动画结束事件
	 * @example <t-animation preset="heartbeat" loop auto-play><t-text>♥</t-text></t-animation>
	 */
	import { useStyle } from '../../common/model/style';
	import { getDomRect } from '../../common/model/util';
	import { TuiAnimation } from '../../common/model/animation'

	// Props 定义
	type AnimationProps = {
		preset : string
		loop : boolean
		autoPlay : boolean
		duration : number
		path : string
		hover : boolean
		type : string
		disabled : boolean
		stop : boolean
		effect : string
		size : string
		mainClass : string
		nativeClass : string
		touchStop : boolean
	}

	const props = withDefaults(defineProps<AnimationProps>(), {
		preset: '',
		loop: false,
		autoPlay: false,
		duration: 300,
		path: '',
		hover: false,
		type: '',
		disabled: false,
		stop: false,
		effect: '',
		size: '',
		mainClass: '',
		nativeClass: '',
		touchStop: false
	});

	const animationData = ref({})
	// 使用 any 类型兼容微信小程序的 wx.createAnimation 返回值
	const animation = ref<any>(null)
	const timer = ref<number>(0)
	const instance = getCurrentInstance()?.proxy!

	const animationStyles = computed(() : string => useStyle(props.mainClass))

	const emit = defineEmits(['click', 'transitionend', 'initFinished'])

	// 确保动画实例已创建
	const ensureAnimation = () : any => {
		if (animation.value == null) {
			const option = {
				duration: props.duration,
				timingFunction: "linear",
				delay: 0,
				transformOrigin: "50% 50% 0"
			}
			// #ifdef MP-WEIXIN
			animation.value = wx.createAnimation(option)
			// #endif
			// #ifndef MP-WEIXIN
			const domEle : UniElement = instance.$el as UniElement
			animation.value = new TuiAnimation(domEle, option)
			animation.value!.onTranSitionEnd(() => {
				emit('transitionend')
			})
			// #endif
		}
		// #ifndef MP-WEIXIN
		animation.value!.reset()
		// #endif
		return animation.value!
	}

	// 播放预设动画
	const playPreset = (presetName : string, loopFlag : boolean = false) => {
		const anim = ensureAnimation()
		switch (presetName) {
			case 'heartbeat': anim.heartbeat(loopFlag); break
			case 'shake': anim.shake(); break
			case 'bounce': anim.bounce(); break
			case 'breathe': anim.breathe(loopFlag); break
			case 'pulse': anim.pulse(loopFlag); break
			case 'fadeIn': anim.fadeIn(props.duration); break
			case 'fadeOut': anim.fadeOut(props.duration); break
			case 'flipX': anim.flipX(); break
			case 'flipY': anim.flipY(); break
			case 'vibrate': anim.vibrate(); break
			case 'blink': anim.blink(loopFlag); break
			case 'popIn': anim.popIn(); break
			case 'popOut': anim.popOut(); break
			case 'slideInLeft': anim.slideInLeft(); break
			case 'slideInRight': anim.slideInRight(); break
			case 'slideInUp': anim.slideInUp(); break
			case 'slideInDown': anim.slideInDown(); break
			case 'jelly': anim.jelly(); break
			case 'rubber': anim.rubber(); break
			case 'spring': anim.spring(); break
			case 'drop': anim.drop(); break
			case 'jump': anim.jump(); break
			case 'headShake': anim.headShake(); break
			case 'nod': anim.nod(); break
			case 'like': anim.like(); break
			case 'spinIn': anim.spinIn(); break
			case 'roll': anim.roll(); break
			case 'wink': anim.wink(); break
			case 'wobble': anim.wobble(loopFlag); break
			case 'pendulum': anim.pendulum(loopFlag); break
			case 'float': anim.float(loopFlag); break
			case 'loading': anim.loading(loopFlag); break
			case 'spin': anim.spin(props.duration); break
			case 'zoomIn': anim.zoomIn(props.duration); break
			case 'zoomOut': anim.zoomOut(props.duration); break
		}
	}

	// 播放动画（使用 props 中的 preset）
	const play = () => {
		if (props.preset != '') {
			playPreset(props.preset, props.loop)
		}
	}

	// 停止循环动画
	const stop = () => {
		animation.value?.stopLoop()
	}

	// 重置到初始状态
	const reset = () => {
		animation.value?.stopLoop()
		animation.value?.resetToInitial()
	}

	// ==================== 预设动画方法（命令式调用） ====================

	const heartbeat = (loopFlag : boolean = false) => { ensureAnimation().heartbeat(loopFlag) }
	const shake = () => { ensureAnimation().shake() }
	const bounce = () => { ensureAnimation().bounce() }
	const breathe = (loopFlag : boolean = false) => { ensureAnimation().breathe(loopFlag) }
	const pulse = (loopFlag : boolean = false) => { ensureAnimation().pulse(loopFlag) }
	const fadeIn = (duration : number = 500) => { ensureAnimation().fadeIn(duration) }
	const fadeOut = (duration : number = 500) => { ensureAnimation().fadeOut(duration) }
	const flipX = () => { ensureAnimation().flipX() }
	const flipY = () => { ensureAnimation().flipY() }
	const vibrate = () => { ensureAnimation().vibrate() }
	const blink = (loopFlag : boolean = false) => { ensureAnimation().blink(loopFlag) }
	const popIn = () => { ensureAnimation().popIn() }
	const popOut = () => { ensureAnimation().popOut() }
	const slideInLeft = () => { ensureAnimation().slideInLeft() }
	const slideInRight = () => { ensureAnimation().slideInRight() }
	const slideInUp = () => { ensureAnimation().slideInUp() }
	const slideInDown = () => { ensureAnimation().slideInDown() }
	const jelly = () => { ensureAnimation().jelly() }
	const rubber = () => { ensureAnimation().rubber() }
	const spring = () => { ensureAnimation().spring() }
	const drop = () => { ensureAnimation().drop() }
	const jump = () => { ensureAnimation().jump() }
	const headShake = () => { ensureAnimation().headShake() }
	const nod = () => { ensureAnimation().nod() }
	const like = () => { ensureAnimation().like() }
	const spinIn = () => { ensureAnimation().spinIn() }
	const roll = () => { ensureAnimation().roll() }
	const wink = () => { ensureAnimation().wink() }
	const wobble = (loopFlag : boolean = false) => { ensureAnimation().wobble(loopFlag) }
	const pendulum = (loopFlag : boolean = false) => { ensureAnimation().pendulum(loopFlag) }
	const float = (loopFlag : boolean = false) => { ensureAnimation().float(loopFlag) }
	const loading = (loopFlag : boolean = true) => { ensureAnimation().loading(loopFlag) }
	const spin = (duration : number = 500) => { ensureAnimation().spin(duration) }
	const zoomIn = (duration : number = 300) => { ensureAnimation().zoomIn(duration) }
	const zoomOut = (duration : number = 300) => { ensureAnimation().zoomOut(duration) }

	// ==================== 原有方法 ====================

	function transitionend(e : UniEvent) {
		// #ifdef MP-WEIXIN
		clearTimeout(timer.value)
		timer.value = setTimeout(() => {
			emit('transitionend')
		}, 500);
		// #endif
	}

	function mainOnclick(e : UniPointerEvent) {
		if (props.stop) e.stopPropagation()
		if (props.path != '') {
			uni.navigateTo({
				url: props.path,
				fail: (_) => {
					uni.switchTab({
						url: props.path
					})
				}
			})
		} else {
			emit('click', e)
		}
	}

	function getInfo(callback : (e : NodeInfo) => void) {
		getDomRect('.tui-animation-main', instance).then((rect : NodeInfo) => {
			callback(rect)
		})
	}

	function createAnimation(e : UTSJSONObject) : any {
		if (animation.value == null) {
			const option = {
				duration: e.getNumber('duration') ?? props.duration,
				timingFunction: e.getString('timingFunction') ?? "linear",
				delay: e.getNumber('delay') ?? 0,
				transformOrigin: e.getString('transformOrigin') ?? "50% 50% 0"
			}
			// #ifdef MP-WEIXIN
			animation.value = wx.createAnimation(option)
			// #endif
			// #ifndef MP-WEIXIN
			const domEle : UniElement = instance.$el as UniElement
			animation.value = new TuiAnimation(domEle, option)
			animation.value!.onTranSitionEnd(() => {
				emit('transitionend')
			})
			// #endif
		}
		// #ifndef MP-WEIXIN
		animation.value!.reset()
		// #endif
		return animation.value!
	}

	function exports() : void {
		// #ifdef MP-WEIXIN
		animationData.value = {}
		nextTick(() => {
			animationData.value = animation.value.export()
		})
		// #endif
		// #ifndef MP-WEIXIN
		animation.value?.export()
		// #endif
	}

	onMounted(() => {
		nextTick(() => {
			getInfo((rect : NodeInfo) => {
				emit('initFinished', rect)
			})
			// 自动播放
			if (props.autoPlay && props.preset != '') {
				playPreset(props.preset, props.loop)
			}
		})
	})

	onUnmounted(() => {
		clearTimeout(timer.value)
		animation.value?.stopLoop()
	})

	defineExpose({
		// 原有方法
		getInfo,
		createAnimation,
		exports,
		// 新增控制方法
		play,
		stop,
		reset,
		// 预设动画方法
		heartbeat,
		shake,
		bounce,
		breathe,
		pulse,
		fadeIn,
		fadeOut,
		flipX,
		flipY,
		vibrate,
		blink,
		popIn,
		popOut,
		slideInLeft,
		slideInRight,
		slideInUp,
		slideInDown,
		jelly,
		rubber,
		spring,
		drop,
		jump,
		headShake,
		nod,
		like,
		spinIn,
		roll,
		wink,
		wobble,
		pendulum,
		float,
		loading,
		spin,
		zoomIn,
		zoomOut
	})
</script>
